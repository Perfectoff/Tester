<!DOCTYPE html>


<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="Sun, 01 Jan 2014 00:00:00 GMT" />
	<title>Tester</title>
	<style>
        * /*стиль для всех элементов*/
        {
			font-family: Verdana,sans-serif;
            font-size: 11pt;
        }
        .child
        {
            display: inline-block;
			//float: top;
            vertical-align: top;
			margin-right: 5pt;
			margin-top: 10pt;
        }
		.header
		{
			font-weight: bold;
		}
        td {
            /*padding: 5px; /* Поля вокруг текста */
            /*border: 1px /* Граница вокруг ячеек */
        }
		p {
			margin-top: 8pt;
			margin-bottom: 8pt;
		}

        #parameters th, #parameters td {
			border: 1px solid;
		}

        /* отобразить контент, связанный с выбранной радиокнопкой (input type="radio") */
        #tabBtnTest:checked~#tabContentTest,
        #tabBtnOpt:checked~#tabContentOptimization {
            display: block;
        }

        #testControls .child,  #optimizControls .child {
            margin-top: -10pt;
		}

		#optimizTable th
		{
            background-color: white;
            position: sticky;
            z-index: 100;
            top: 0;
		}

		tr.selected td
		{
            background-color: black;
			color: white;
		}

        @media screen and (orientation:landscape)
        {
            body
            {

            }
        }

		body {
            -webkit-text-size-adjust: 100%;  /* Иначе в Гугл Хром сбиваются шрифты на мобильной версии */
		}

		/*Раскраска чётных рядов таблицы оптимизации*/
		#optimizTableBody tr:nth-child(odd)
		{
            background-color: #fffff0;
		}


		.optimizInputRange {
            /*width: 100%;*/
			width: 120pt;
            -webkit-appearance: none;
            margin: 0;
			margin-bottom: 20pt;

        }
        .optimizInputRange:focus {
            outline: none;
        }
        .optimizInputRange::-webkit-slider-runnable-track {
            /*width: 100%;*/
            height: 19px;
            cursor: pointer;
            box-shadow: 0 4px 4px rgba(0,0,0,0.3) inset;
            background: linear-gradient(to right, #005fc2, #FF0000);
            border-radius: 20px;
            border: 0.2px solid #010101;
        }
        .optimizInputRange::-webkit-slider-thumb {
            box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
            border: 1px solid #000000;
            height: 20px;
            width: 20px;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -1px;
        }



    </style>

	<link rel="stylesheet" href="./font-awesome/css/all.css">

	<link rel="stylesheet" href="./tabs.css">

	<script src="jquery-3.5.1.min.js"></script>

	<link rel="stylesheet" type="text/css" href="./tsort/tsort.css">

	<script src="./tsort/tsort.min.js"></script>

	<link rel="stylesheet" href="./popup.css">

<!--	Для отключения запроса favicon-->
	<link rel="icon" href="data:,">

<!--	<script type="text/javascript" src="./jquery.tablesorter.min.js"></script>-->
</head>

<body>

	<form id="form" style="">

		<div style="width:max-content">
			<div class="child header">
				<label for="symbol">Symbol</label>
				<p><select id="symbol" size="1">  <!-- <select size="3" multiple name="hero[]"> -->
					<!-- <option disabled>Выберите символ</option>-->
					<option selected value="BTCUSD">BTCUSD</option>
					<option value="ETHUSD">ETHUSD</option>
					</select>
				</p>
				<label for="fee">Комиссия</label>
				<p style="margin: 0 0 10pt 0">
					<input type="number" id="fee" style="width: 40pt;" value="0.1" min="0" step="0.01"> <!--onkeypress="this.step= Math.pow(10, lib.GetDblPrecision(this.value))">-->
					<select id="feeType" style="min-width: 30pt; ">
						<option selected>%</option>
						<option >$</option>
					</select>
				</p>

				<!--
				<input type="text" name="example" list="exampleList">
				<datalist id="exampleList">
					<option selected value="BTCUSD">
					<option value="ETHUSD">
				</datalist>
				-->
			</div>
			<div class="child header">
				<label for="strategy">Strategy</label>
				<p><select id="strategy" size="1">  <!-- <select size="3" multiple name="hero[]"> -->
					<!-- <option disabled>Выберите стратегию</option>-->
<!--					<option value="Moving Average">Moving Average</option>-->
				</select></p>
			</div>
			<div class="child header">
				<label for="startDate">Начало</label>
				<p>
					<input type="date" id="startDate" name="startDate" value="2020-11-01">
				</p>
			</div>
			<div class="child header">
				<label for="endDate">Конец</label>
				<p>
					<input type="date" id="endDate" name="endDate" value="2020-11-30">
				</p>
			</div>
			<div class="child header">
				<label for="tf">Таймфрейм</label>
				<p><select id="tf" size="1">
					<option>M1</option>
					<option>M5</option>
					<option>M15</option>
					<option selected>H1</option>
					<option>H4</option>
					<option>D1</option>
				</select>
				</p>
			</div>
			<div class="child header">
				<label for="parameters">Параметры стратегии</label>
				<input id="fileInput" type="file" style="display:none;" />
				<span style="margin-left: 10pt;">
					<button type="button" onclick="$('#fileInput')[0].click();" disabled><i class='far fa-folder-open'></i></button>
					<button type="button" onclick="$('#fileInput')[0].click();" disabled><i class='fas fa-save'></i></button>
				</span>
				<p>
<!--					<table id="parameters" border=1px style="border-collapse:collapse; border-left:none ">-->
					<table id="parameters" style="border-collapse:collapse;">
						<thead>
							<tr style="">
								<th>Параметр</th>
								<th style="width:50pt" id="paramValueHeader">Value</th>
								<th style="width:50pt" class="cellParamOptim">Start</th>
								<th style="width:50pt" class="cellParamOptim">End</th>
								<th style="width:50pt" class="cellParamOptim">Step</th>
								<th style="width:50pt;font-size:small" class="cellParamOptim">Progres.</th>
								<th style="border: 0" class="cellParamOptim"></th>
							</tr>
						</thead>
						<tbody id="paramTableBody" style="font-weight: normal;">
						</tbody>
					</table>

					<script>
						/** Добавление параметра стратегии в таблицу
						 * @param {string} name
						 * @param {CParamValueInfo} info
						 * @param {ValueInfo} valueInfo
						 */
						function AddStrategyParameterToTable(name, info, valueInfo=null) {
							//let styleStr="style='text-align:center'";
							let table = $("#paramTableBody");
							let tr = document.createElement("tr");
							//rows.push(`<tr><td>${point.time}</td> <td>${point.volume}</td> <td>${point.volumeTotal}</td></tr>`);
							//.each((e)=>alert(e))
							//console.log(info);
							tr.innerHTML =
								`
								<td>${name}</td>
								<td><input class='inputParamValue' type="number" style="text-align: center; border:0; width:50pt;" value='${info?.single}'></td>
								<td class="cellParamOptim"><input class='inputParamStart' type="number" style="text-align: center; border:0; width:50pt" value='${info?.start}' hidden></td>
								<td class="cellParamOptim"><input class='inputParamEnd' type="number" style="text-align: center; border:0; width:50pt" value='${info?.end}' hidden></td>
								<td class="cellParamOptim"><input class='inputParamStep' type="number" style="text-align: center; border:0; width:50pt" value='${info?.step}' hidden></td>
								<td class="cellParamOptim"><input class='inputParamProgres' type="number" lang="en" min="1" step="0.000001" style="text-align: center; border:0; width:50pt" value='${info?.progres??""}' hidden></td>
								<td class="cellParamOptim" style='border:0; text-align: right;' hidden>
									<input type="checkbox" class='inputParamCheckBox' onchange="$(this).parent().parent().find('input[type=number]').toggle()">
								</td>
								<td class="cellParamComboCount" style="border:0; padding-left: 10pt; font-style:italic; cursor:pointer"></td>
								`;
							for(let el of tr.getElementsByClassName("cellParamOptim")) el.hidden= true;

							let inputValuesElements= $(tr).find(".inputParamValue,.inputParamStart,.inputParamEnd");
							//console.log(name, valueInfo?.min);

							if (valueInfo?.min!=null)
								inputValuesElements.each((i,el) => el.min= valueInfo.min);
							if (valueInfo?.max!=null)
								inputValuesElements.each((i,el) => el.max= valueInfo.max);
							if (valueInfo?.step!=null) {
								inputValuesElements.each((i, el) => el.step= valueInfo.step);
								$(tr).find(".inputParamStep")[0].step= valueInfo.step;
							}
							//tr.style.textAlign= 'right';
								//`<td>${timeStr}</td> <td ${styleStr}>${point.volume}</td> <td>${point.price}</td> <td ${styleStr}>${point.volumeTotal}</td>`;
							table.append(tr);
						}

						function ClearStrategyParameterTable() {
							$("#paramTableBody").empty();
						}

						//AddStrategyParameterToTable('1st MA period', 10,  1, 20, 1, 1.1);
						//AddStrategyParameterToTable('2nd MA period', 20,  5, 100, 5, 1.1);
					</script>

				</p>
			</div>
		</div>

		<!-- ВКЛАДКИ -->
		<div class="tabs" style="float: left">
			<input type="radio" name="tab-btn" id="tabBtnTest" value="" checked  onchange="$('.inputParamCheckBox:checked').trigger('click');  $('.cellParamOptim').hide();">
			<label for="tabBtnTest">Тестирование</label>
			<script>let __OptTabWasClicked= false; </script>
			<input type="radio" name="tab-btn" id="tabBtnOpt" value=""  onchange="$('.cellParamOptim').show();  if (!__OptTabWasClicked) $('.inputParamCheckBox:not(:checked)').trigger('click');   __OptTabWasClicked=true;">
			<label for="tabBtnOpt">Оптимизация</label>

			<script> $('.cellParamOptim').hide() </script>

			<!-- ВКЛАДКА ТЕСТА -->
			<div id="tabContentTest" style="width:max-content">
				<!-- ЗАПУСК ТЕСТА -->
				<div id="testControls" style="left:230pt; position: relative">
					<div class="child">
						<p><input id="startBtn" type="submit" value="Старт" style="font-size:medium" onsubmit=''></p>
					</div>
					<div class="child" style="margin-left: 15pt">
						<p><input type="checkbox" id="visualModeCB" onchange='{$("#speedDiv").toggle(); $("#pauseBtn").toggle()}' checked>
							визуал. режим
						</p>
					</div>
					<div class="child" id="speedDiv" style="margin-left: 15pt;">
						<p style="vertical-align: top; height: 1pt;  margin-block: 0">
							<label for="speed" style="vertical-align: top; height: 3pt;">скорость</label>
							<p><input id="speed" type="range" min="0" max="100" step="1" value="50" style="margin-top: 3pt"></p>
						</p>
					</div>
					<div class="child">
						<p>
		<!--				<input id="pauseBtn" type="button" class="child" value="&#x23f8;&#xFE0E;" style="font-size:medium; font-family: 'Segoe UI Symbol'; font-weight: bold" disabled>-->
						<button id="pauseBtn" type="button" class="fa fa-pause" style="font-size:large" disabled></button> <!-- type="button" for not submitting a form on click -->
		<!--				<i class="fa fa-pause"></i>-->
						</p>
					</div>
		<!--			<p class="child"><button id="pauseBtn" style="font-size:medium; font-family: 'Segoe UI Symbol'; font-weight: bold">-->
		<!--				<span style="padding-bottom: 2pt;>&#x23f8</span></button></p>-->
					<!--<p class="child"><input id="pauseBtn2" type="button" value="&#x25B6" style="font-size:medium; width:30pt;height:20pt; font-weight: bold"></p>-->
				</div>
				<div style="margin-top:-20pt"><progress id="testProgressBar" max="100" value="0" style="width:150pt">Статус тестирования</progress></div>

				<div style="margin-top: 0pt; width: max-content">

				<!-- ТАБЛИЦА СДЕЛОК -->
					<div class="child" style="margin-right: 10pt">
						<label style="font-size: large;">Торговля</label>
						<table id="tradeTable" border="1px" style="margin-top:5pt">
							<tr>
								<th style="min-width:70pt">Время</th>
								<th style="">Объём<br>сделки</th>
								<th style="">Цена</th>
								<th style="">Объём<br>позиции</th>
							</tr>
							<tbody id="tradeTableBody">
							<tr>
								<td> </td>
								<td> </td>
								<td> </td>
								<td> </td>
							</tr>
							</tbody>
						</table>
					</div>

					<script>

						function str(n) { return n<=9 ? '0'+n : ''+n; }
						/**
						 * @param{Date} date
						 * @returns {string}
						 */
						function timeToStr_yyyymmdd_hhmm(date) { return date.getUTCFullYear()+"-"+str(date.getUTCMonth()+1)+"-"+str(date.getUTCDate())+" "+str(date.getUTCHours())+":"+str(date.getUTCMinutes()); }


						//class TradeData {time; volume; volumeTotal }
						/**
						 * @param{TradeData[]} array
						 * @param{function(string)} onclick
						 */
						function AddTradesToTable(array= [], onclick=null) {
							//let rows= [];
							let table = $("#tradeTableBody");
							//table.empty();  // очистка
							let styleStr="style='text-align:center'";
							for (let point of array) {
								let tr = document.createElement("tr");
								//rows.push(`<tr><td>${point.time}</td> <td>${point.volume}</td> <td>${point.volumeTotal}</td></tr>`);
								let timeStr = point.time instanceof Date ? timeToStr_yyyymmdd_hhmm(point.time) : point.time;
								tr.innerHTML = `<td style="cursor: pointer">${timeStr}</td> <td ${styleStr}>${point.volume}</td> <td>${point.price}</td> <td ${styleStr}>${point.volumeTotal}</td>`;
								tr.onclick= function() {
									//alert($(this).text());
									$(this).addClass('selected').siblings().removeClass('selected');
									//let timeStr = $(this).find('td:first').html();
									if (onclick) onclick(timeStr);
									//alert(value);
								};
								table.append(tr);
							}
							/*
							$("#tradeTableBody tr")[0].onclick= function(){
								$(this).addClass('selected').siblings().removeClass('selected');
								let value=$(this).find('td:first').html();
								alert(value);
							};
							*/

						}

						function ClearTradeTable() { $("#tradeTableBody").empty(); }

						function FillTradeTable(array= [],  onclick=null) { ClearTradeTable();  AddTradesToTable(array, onclick); }
							//alert($("#tradeTableBody"));
							//alert(rows);
							//alert($("#tradeTableBody"));
							//$("#tradeTableBody").innerHTML= rows.join("");
							//alert(rows.join("")); //$("#tradeTableBody").innerHTML)

						//FillTradeTable([{time: 100, volume: 1, volumeTotal: 10}]);
					</script>
					<div class="child" style="margin-top:0;">

						<!-- ГРАФИКИ -->
						<div class="child" style="min-width: 800px;  resize: horizontal; overflow: hidden">
							<label style="font-size: large;  text-align: right">График</label>
							<p id="quotesChartName" style="position: absolute; z-index: 999; color: white; margin-top:8pt; margin-left:4pt;">Symbol</p>
							<div id="quotesChart" style="width:100%;  height: 250px; border:1px solid; margin-top:5pt; background: black;">
							</div>
							<div style="position: absolute; z-index: 999; color: white; margin: 5pt">Equity</div>
							<div id="equityChart" style="width:100%;  height: 250px; border:1px solid; margin-top:5pt; background: black; ">;

							</div>
						</div>

						<!-- СТАТИСТИКА -->
						<div id="statisticsDiv" class="child" style="">
							<label style="font-size: large;">Статистика</label>
							<table border="1px" style="margin-top:5pt">
								<tbody id="statisticsTableBody">
								<tr>
									<td> </td>
									<td> </td>
								</tr>
								</tbody>
							</table>
						</div>
						<script>
							{
								let __lastWidth = 0;
								let __defaultPos= $("#statisticsDiv").position().left+80;

								function AdjustStatisticsTablePosition() {
									let width = "max-content";
									//alert(window.innerWidth+"  "+window.outerWidth);
									if (Math.min(window.innerWidth) < __defaultPos || window.screen.orientation.type==="portrait-primary") width = '100%';
									//console.log(window.screen.orientation);
									if (width !== __lastWidth) $("#statisticsDiv")[0].style.width = width;
									__lastWidth = width;
								}
								AdjustStatisticsTablePosition();
								window.onresize = () => AdjustStatisticsTablePosition(); // {alert(($("#statisticsDiv").position().left +"  "+window.innerWidth+" "+ window.outerWidth)); }
							}
						</script>
					</div>
				</div>
			</div>

			<!-- ВКЛАДКА ОПТИМИЗАЦИИ -->
			<div id="tabContentOptimization" style="width: max-content">
				<div id="optimizControls" style="left:230pt; position: relative;">
					<div class="child">
						<p><input id="startOptimizBtn" type="submit" value="Старт" style="font-size:medium;" onsubmit=''></p>
					</div>
					<div class="child" style="margin-left:10pt;">
						<p style="display:block; width: 750pt;">
							<label>Число потоков:
								<select id="threadsCountInput" size="1"> <!-- <select size="3" multiple name="hero[]"> -->
	<!--							<option value="-">-</option>-->
									<option value="1">1</option>
								</select>
							</label>
							<span style="margin-left: 30pt">Число комбинаций:</span>
							<span id="paramComboCount" style="">-</span>
							<label>
								<input id="onlyPositiveResults_checkBox" type="checkbox" style="margin-left: 15pt" checked>
								Сохранять только положительные
							</label>
							<div>
								<label style="vertical-align: top">
									<input id="genetic_checkBox" type="checkbox" onchange="$('#threadsCountInput')[0].style.visibility= this.checked ? 'hidden' : 'visible'">
									Генетический алгоритм
								</label>
								<div style="display: inline-block; margin-left: 3pt">
									<button class="fa fa-wrench" type="button" onclick="$('#geneticConfig').toggle()"></button>
									<table id="geneticConfig" style="border: 1px dotted;" hidden>
									<tr><td>Размер популяции: </td><td><input id="geneticPopulation" type="number" value="250" min="1" style="width:50pt"></td></tr>
									<tr><td>Вероятность скрещиваний: </td><td><input id="geneticCrossProb" type="number" value="90" min="0" max="100" style="width:25pt">%</td></tr>
									<tr><td>Вероятность мутаций: </td><td><input id="geneticMutateProb" type="number" value="20" min="0" max="100" style="width:25pt">%</td></tr>
									<tr><td>Число неулучшающихся поколений: </td><td><input id="geneticStopEpochs" type="number" value="5" min="1" style="width:25pt"></td></tr>
									<tr><td>Минимальное число сделок: </td><td><input id="geneticMinTradesCount" type="number" value="0" min="0" style="width:25pt"></td></tr>
									</table>
								</div>
							</div>
						</p>

						<script>
							/**@return {MyGeneticParams}
							 */
							function GetGeneticConfig()
							{
								/**@type{MyGeneticParams}*/
								let config= {};
								config.populationSize= $("#geneticPopulation").val();
								config.crossoverProbability= $("#geneticCrossProb").val()/100;
								config.mutationProbability= $("#geneticMutateProb").val()/100;
								config.badEpochs= $("#geneticStopEpochs").val();
								config.minTradesCount= $("#geneticMinTradesCount").val();
								return config;
							}
						</script>

						<script> for(let i=2; i<navigator.hardwareConcurrency+1; i++) $('#threadsCountInput').append(`<option value="${i}">${i}</option>`); </script>

						<script> function UpdateParamComboCount() { } </script>
					</div>

				</div>

				<div class="child" style="min-width: 170pt; margin-right: 10pt;">
					<div id="optimizStatus" style="display:block; margin-top:3pt; visibility:hidden">
						<progress id="optimProgressBar" max="100" style="width: 150pt">Статус выполнения</progress>
						<div id="optimizStatusText" style="white-space:pre;">status</div>

						<div id="optimizParamRangesDiv" style="display:inline-block; position:absolute; margin-left: 10pt; margin-top: 20pt">
							<!--							<div><label>Param1-->
							<!--								<input class="optimizInputRange" type="range">-->
							<!--							</label></div>-->
							<!--							<div><label>Param2-->
							<!--								<input class="optimizInputRange" type="range">-->
							<!--							</label></div>-->
						</div>
					</div>

<!--					<canvas id="testCanvas" width="550" height="450"></canvas>-->

					<script>
						//let canvas = document.getElementById( "testCanvas" );

						//const dataArr = [ 6, 8, 10, 12, 11, 7, 5, 8 ];

						//DrawChart(canvas, dataArr);

						/**
						 * @param {HTMLCanvasElement} canvas
						 * @param {number[]} dataArr
						 */
						function DrawCanvasChart(canvas, dataArr)
						{
							let context = canvas.getContext("2d");

							const arrayLen = dataArr.length;
							// calculate max and min
							let [max, min] = dataArr.reduce(([max,min], value)=>[Math.max(max,value), Math.min(min,value)], [Number.MIN_VALUE, Number.MAX_VALUE]);

							const GRAPH_HEIGHT = canvas.height; //350;
							const GRAPH_WIDTH = canvas.width; // 450;

							const GRAPH_TOP = 0; //25;
							//const GRAPH_BOTTOM = 375;
							const GRAPH_LEFT = 0; //25;

							context.beginPath();
							// make your graph look less jagged
							//context.lineJoin = "round";
							context.strokeStyle = "black";
							// add first point in the graph
							context.moveTo( GRAPH_LEFT, ( GRAPH_HEIGHT - dataArr[ 0 ] / max * GRAPH_HEIGHT ) + GRAPH_TOP );
							let range= max!==min ? max-min : 1;
							// loop over data and add points starting from the 2nd index in the array as the first has been added already
							for(let i= 1; i<arrayLen; i++){
								context.lineTo( Math.round(GRAPH_WIDTH / arrayLen * i + GRAPH_LEFT), Math.round( GRAPH_HEIGHT - (dataArr[i] - min) / range * GRAPH_HEIGHT ) + GRAPH_TOP );
							}
							// actually draw the graph
							context.stroke();
						}
					</script>
				</div>
				<!-- ТАБЛИЦА ОПТИМИЗАЦИИ -->
<!--				<div class="child" style="margin-right: 10pt; margin-left: 200pt">-->
				<div class="child" style="margin-right: 10pt;">
					<label style="font-size: large;">Результаты оптимизации
<!--						<div id="optimizStatus" style="display:block; margin-top:3pt; float:right; visibility:hidden; white-space:pre;">status</div>-->
					</label>
					<div style="">
					<table id='optimizTable' class="tsort" border="1px" style="margin-top:5pt; text-align: right; display: inline-block">
						<thead>
							<tr>
								<th style="" class="sel">№</th>
								<th style="">Прибыль</th>
								<th style="">Просадка</th>
								<th style="">Факт.восст.</th>
								<th style="">Коэф.Шарпа</th>
								<th style="">Cделки</th>
								<th style="">Параметры</th>
								<th style="">График</th>
							</tr>
						</thead>
						<tbody id="optimizTableBody">
						<tr>
						</tr>
						</tbody>
					</table>

						<div class="child" id="" style="margin-left: 20pt; width: 400px">
							<p id="optimizItemChartName" style="position: absolute; z-index: 999; color: white; margin-top:8pt; margin-left:4pt;">Profit</p>
							<div id="optimizItemChartDiv" style="width:100%;  height: 250px; border:1px solid; margin-top:5pt; background: black">
							</div>
						</div>


					<script type="module"> import { DblToStrAuto } from "./Common.js";  document.DblToStrAuto= DblToStrAuto; </script>

					<script>

						$( document ).ready(function() {
							$('.tsort').tsort();
						});

						/** Запустить тестирование с выбранными параметрами
						 * @param{number[]} params
						 */
						function RunTestParams(params) {
							$("#tabBtnTest").trigger('click');
							//ClearStrategyParameterTable();
							let paramInputs= [...$("#parameters .inputParamValue")];
							if (paramInputs.length !== params.length) { throw("Wrong parameters count"); }
							for(let i=0; i<paramInputs.length; i++) paramInputs[i].value= params[i];
							if ($("#visualModeCB")[0].checked) $("#visualModeCB").trigger('click');
							$("#startBtn").trigger('click');
							//document.OnClickStartBtn(false);
							//$("#optimizItemChartDiv")
							//for(let param of params) (//AddStrategyParameterToTable(param, 0, 0, 0);
						}

						// $(document).ready(function()
						// 	{
						// 		$("#optimizTable").tablesorter();
						// 	}
						// );

						/** Добавить результат в таблицу оптимизации
						 * @param {number[]} params
						 * @param {TradeStatistics} statistics
						 * @param {number[]} equityValues
						 */
						function AddResultToOptimizTable(params, statistics, equityValues =null)
						{
							let table = $("#optimizTableBody");
							let i= table.children().length+1;
							let tr = document.createElement("tr");
							function valToStr(val) { return val!==undefined ? document.DblToStrAuto(val, -4) : "-"; }
							tr.innerHTML =
								`
								<td>${i}</td>
								<td>${valToStr(statistics.resultProfit)}</td>
								<td>${valToStr(statistics.maxDrawdown)}</td>
								<td>${valToStr(statistics.recoveryFactor)}</td>
								<td>${valToStr(statistics.sharpCoef)}</td>
								<td>${valToStr(statistics.trades)}</td>
								<td>${params.join(", ")}</td>
								<td><canvas style="width: 50pt; height: 10pt"></canvas></td>
								<td class='optResultButtonCell' style="border:0; padding-top:0;padding-bottom:0" hidden><button type='button' style="">тест</button></td>
								`;
							$(tr).find('button').on('click',()=>RunTestParams(params));

							let canvas= $(tr).find("canvas")[0];
							if (equityValues) { DrawCanvasChart(canvas, equityValues);  } //console.error(equityValues);

							//$(tr)[0].style.backgroundColor= i%2===1 ? "#FFFFF0" : "#FFFFFF";
							//tr.style.border='0';
							//tr.append("<button type='button'>тест</button>");
							//tr.onmouseenter= ()=>tr.append('<p>hi '+i+'</p>');//=>console.log(i);
							//tr.onmouseleave= ()=>tr.lastChild.remove();
							table.append(tr);
						}

						function ClearOptimizTable() {
							$("#optimizTableBody").empty();
							$("#optimizTable thead th").removeClass("sel");
							$("#optimizTable thead tr :first-child").addClass("sel");
						}
					</script>
					</div>

				</div>

			</div>
		</div>
	</form>

</body>


	<script>
		function js_alert(args) { alert(args); }
		function js_print(args) { console.log(args);}
		//console.log("!!");
		//alert("!!!");
	</script>


	<!--<script src="/Tester.js"></script>-->
	<!--<script type="module" src="/Strategy.js"></script>-->
	<!--<script type="module" src="/Tester.js"></script>-->

<!--	<script src="/Chart_amCharts.js"></script>-->
<!--	<script type="text/javascript" src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>-->

<!--	<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>-->
<!--	<script src="/Chart/lightweight-charts.standalone.development.js"></script>-->
	<script>

	</script>

	<script type="tsx">
		//import type {Number, HTMlElement} from "@types"
		import * as MSTrade from "./Data_MSTrade";
		import * as lib from "./Common";

		import * as Time from "./Time";
		type Time_type= typeof Time;

		import * as MyTester from "./MyTester"
		type MyTester_type= typeof MyTester;

		type CParamStepper= MyTester.CParamStepper;

		import { MyGeneticParams } from "./Optimizer.js"

		import * as Param from "./Param"

		import { IStrategy } from "./Strategy";

		import type { Period } from "./Time.js";

		interface HTMLElement { }
		interface String { }
		interface JQuery<T> { }

		declare function $(arg :string) : JQuery<HTMLElement>;

		import {ShowStatistics} from "./index_helper";
		//helper.
		type ShowStatistics_type= typeof ShowStatistics;
		//let c= new MyTester.CTesterSpeed;
	</script>



	<script async type="module">
		//MyTester;
		//import { Period } from "./Time";

		//moduleFunc();
		//async function moduleFunc()

			//let MyTester= MyTester;
			//let c = MyTester.CTesterSpeed;

		import * as MSTrade from "./Data_MSTrade.js";

		import { DrawCandleChart } from "./Chart/Chart.js";

		import * as lib from "./Common.js";

		//await lib.sleepAsync(100);
		//alert("!");//fff());
		import { CSymbolInfo, CTesterConfig, CTesterInfo, RunTest } from "./TesterAPI.js";

		import { Strategy_MA, Strategy_Pan, Strategy_Lana } from "./Strategies.js";


		/** @type{Time_type}
		 */
		import * as Time from "./Time.js";  //Time= await import("./Time.js");   // Такой вариант, иначе PHPStorm не видит его

		import { TF, TIME_UNIT } from "./Time.js";

		/** @type{MyTester_type}
		 */
		import * as MyTester from "./MyTester.js";

		import * as Param from "./Param.js";

		//MyTester= await import("./MyTester.js");   // Такой вариант, иначе PHPStorm не видит его

		//MyTester= _MyTester;
		import {TradeStatistics} from "./MyTester.js"


		//import type * as MyTester from "./MyTester"

		//import * as Tester from "./TesterAPI.js";
		//import {RunSignallerTest} from "./Tester.js";

		//import { DrawCandleChart } from "./Chart2";
		//alert("??????? exit");

		import {SetAutoStepForElement} from "./index_helper.js";


		/**@type {JQuery<HTMLSelectElement>} */
		const $symbol = $("#symbol");
		/**@type {JQuery<HTMLSelectElement>} */
		const $strategy = $("#strategy");
		/**@type {JQuery<HTMLSelectElement>} */
		const $tf = $("#tf");
		/**@type {JQuery<HTMLInputElement>}*/
		const $startDate = $("#startDate");
		/**@type {JQuery<HTMLInputElement>} */
		const $endDate = $("#endDate");

		const $quotesChart= $("#quotesChart");
		const $quotesChartName= $("#quotesChartName");
		const $equityChart= $("#equityChart");

		async function LoadSymbolBars() {
			//alert(111);  return;
			//$("#quotesChartName")[0].innerText = "fuck";  return;
			let symbol = $symbol.val();
			let tfName = $tf.val();
			let tf= TF.get(tfName);
			if (!symbol || !tf) return false;
			let bars = await MSTrade.GetQuotesCacheable(symbol, tf, new Date(Date.now()-1000*tf.msec), new Date);
			if (_testing) return;
			$quotesChart.empty();
			DrawCandleChart(bars, $quotesChart[0]);  //
			$quotesChartName[0].innerText = symbol+", "+tfName;
			$quotesChartName[0].style.color= 'white';
			$quotesChartName[0].style.fontSize= "small";
		}

		$symbol[0].onchange= LoadSymbolBars; // .addEventListener('change', LoadSymbolBars);
		$tf[0].onchange= LoadSymbolBars; ////.addEventListener('change', LoadSymbolBars);

		LoadSymbolBars();
		//$(document).on('change', '#tf', function(e){ alert("!"); }

		class CParamValueInfo { start; end; step; progres; single; };


		const $paramTableBody= $("#paramTableBody");

		/** Хэшмэп состояния таблицы параметров по названию стратегии
		 * @type {Map<string, string>}
		 */
		const stategyParamTableState = new Map;

		// /** Хэшмэп состояния параметров по названию стратегии
		//  * @type {Map< string, { info :CParamValueInfo, checked :boolean }[] >}
		//  */
		// let stratParamStates= new Map;

		/**
		 * @param { IStrategy } strategy
		 * @param { CParamValueInfo[] } valuesConfigs - Конфигурации параметров
		 */
		function _SetStrategyParams(strategy, valuesConfigs=null)
		{
			let params= strategy.params;
			ClearStrategyParameterTable();
			//let state= stategyParamTableState.get(strategy.name);
			//if (state) { $pramTableBody[0].innerHTML= state;  return; }
			let i=0;
			for(let param of params) {
				//let checked=false;
				let config= valuesConfigs ? valuesConfigs[i] : null;
				let info= param.type.valuesInfo;
				let defaultValue= param.defaultValue;
				let defaultRange= param.defaultRange;
				//if (!info) [info,checked]= state ? state[i]: null;
				if (!config) config= defaultRange ? {...defaultRange, progres: info.progressive ? 1.1 : 1, single: defaultValue ?? defaultRange.start} : null;
				if (!config) {
					//console.log(param);
					let start= info.min ?? defaultValue;
					let end= info.max ?? defaultValue;
					let step = start!=null && end!=null  ? (info.step ?? (end - start)/10)  : null;
					let single= defaultValue ?? start;
					if (step) config= { start, end, step, single, progres: info.progressive };
				}

				AddStrategyParameterToTable(param.name, config, param.type.valuesInfo); //info?.single, info?.start, info?.end, info?.step, info?.progres);
				//AddStrategyParameterToTable('1st MA period', 10,  1, 20, 1, 1.1);
				//AddStrategyParameterToTable('2nd MA period', 20,  5, 100, 5, 1.1);
				i++;
			}
			$(".inputParamProgres").each((index,element)=>SetAutoStepForElement(element));
		}

		let currentStrategyName;

		/** Хэшмэп стратегий по имени
		 * @type {Map<string, IStrategy>}
		 */
		const stategiesMap = new Map;

		let $paramTable = $("#parameters");


		function SaveCurrentStrategyParams() {
			//let checkboxesStates = $(".inputParamCheckBox").map((i, el)=>el.checked);
			stategyParamTableState.set(currentStrategyName, $paramTable[0].innerHTML); //[$paramTable[0].innerHTML, checkboxesStates]);
		}
		/**@param{string} strategyName
		 */
		function RecoverStrategyParams(strategyName) {
			//let [innerHtml, checkboxStates] = stategyParamTableState.get(currentStrategyName);
			$paramTable[0].innerHTML= stategyParamTableState.get(currentStrategyName);
			$(".inputParamCheckBox").each((i, el)=> { el.checked= $(".inputParamStart")[i].style.display!=="none"; });
		}

		/**
		 * @param {IStrategy} strategy
		 * @param {CParamValueInfo[]} valuesConfigs
		 */
		function AddStrategy(strategy, valuesConfigs= null)
		{
			SaveCurrentStrategyParams();
			let name= strategy.name;
			$strategy.append('<option value="'+name+'">'+name+'</option>');
			//$strategy[0].selectIndex= $strategy[0].length-1;
			$strategy[0].value= name;
			//alert($strategy[0].selectIndex);
			_SetStrategyParams(strategy, valuesConfigs);
			currentStrategyName= name;
			stategiesMap.set(name, strategy);
		}

		if (1)
		AddStrategy(Strategy_MA,
			[
				{ single: 10,  start: 1, end: 50, step: 1, progres: 1.1 },
				{ single: 20,  start: 2, end: 100, step: 2, progres: 1.1 },
				//{ single: 0,  start: 0, end: 1, step: 1, progres: 1 }
			]
		);
		if (1)
			AddStrategy(Strategy_Lana//,
					// [
					// 	{ single: 10,  start: 1, end: 50, step: 1, progres: 1.1 },
					// 	{ single: 20,  start: 2, end: 100, step: 2, progres: 1.1 },
					// 	//{ single: 0,  start: 0, end: 1, step: 1, progres: 1 }
					// ]
			);
		if (1)
		AddStrategy(Strategy_Pan);


		$strategy.on("change", ()=> {
			//alert($strategy.val());
			SaveCurrentStrategyParams();
			currentStrategyName= $strategy.val();
			RecoverStrategyParams(currentStrategyName);
			ShowAmountOfCombinations()
			// Пересчитываем и отображаем число комбинаций при изменении любого параметра
			$("#parameters :input").on("change", ()=> ShowAmountOfCombinations() );
		});

		// Пересчитываем и отображаем число комбинаций при изменении любого параметра
		$("#parameters :input").on("change", ()=> ShowAmountOfCombinations() );


		let _testing= false;

		let _paused= false;

		let testerSpeedMutable = new MyTester.CTesterSpeed;

		/**@type {JQuery<HTMLElement>}*/
		const $startBtn= $('#startBtn');
		/**@type {JQuery<HTMLElement>}*/
		const $pauseBtn= $('#pauseBtn');
		/**@type {JQuery<HTMLInputElement>}*/
		const $visualCheckbox= $('#visualModeCB');
		/**@type {JQuery<HTMLInputElement>}*/
		const $speedRange= $('#speed');
		/**@type {JQuery<HTMLInputElement>}*/
		const $onlyPositiveResultsCheckBox = $("#onlyPositiveResults_checkBox");

		//$('#Speed')[0].addEventListener('input', alert("!"));
		//$('#Speed')[0].addEventListener('change', ()=>alert("!"));

		$speedRange.on('input', ()=> {
			let value= $speedRange[0].value;
			if (!_paused)
				testerSpeedMutable.value = value; //=  ()=>alert($('#speed')[0].value));
		});

		$speedRange.on('change', ()=> {  //$('#speed')[0].addEventListener
			let value= $speedRange[0].value;
			console.log("Set testing speed=",value);
			if (!_paused)
				testerSpeedMutable.value = value; //=  ()=>alert($('#speed')[0].value));
		});

		//alert($('#visualModeCB')[0].checked);

		//const pauseChar= "\u23F8\uFE0E";//\uFE0E'; //U+23F8;
		//const playChar= '\u23F5\uFE0E';
		////const playChar= '\u25B6'; //U+25B6; //'&#x25B6';

		if ($visualCheckbox[0].checked) $speedRange.trigger("change");

		/** @param{boolean} paused */
		function SetPaused(paused) {
			if (paused) testerSpeedMutable.value = 0;
			else        testerSpeedMutable.value = $speedRange[0].value;
			_paused = paused;
			//$pauseBtn[0].value = paused ? playChar : pauseChar; //
			$pauseBtn[0].className= paused ? "fa fa-play" : "fa fa-pause";
			$pauseBtn[0].title= paused ? "Продолжить" : "Пауза";
		}

		$pauseBtn[0].onclick= ()=>SetPaused(!_paused);

		SetPaused(false); //'&#x25B6';

		// Показать общее число комбинаций
		function ShowAmountOfCombinations() {
			let errors= [];
			let infos= GetParamsOptimizArrays( function onErr(i,msg) { errors[i]=msg; } );
			$('.cellParamComboCount').each((i, el)=> {
				el.innerHTML= infos && infos[i] ? "["+infos[i].length+"]" : errors[i] ? "<span style='color:red'>"+errors[i]+"</span>": "";
				//if (!infos || !infos[i]) console.log($('#parameters tbody tr')[i]); tr.getElementsByClassName('')[0].checked
				let border= (infos && infos[i]) ? "1px solid" : "2px red solid";
				$($('#parameters tbody tr')[i]).find("td:has(input[type=number])").css("border", border); //"").style.border= "2px red";  // :HTMLElement
			})
			$("#paramComboCount")[0].innerHTML = infos?.reduce((prev, curr) => prev * curr?.length, 1);
		}


		ShowAmountOfCombinations();

		/**@param{HTMLElement} e
		 */
		function isHover(e) { return e.parentElement?.querySelector(':hover') === e; }  //element.matches(':hover') или [element]:hover

		let __lastClickTarget;
		// События клика на числе комбинаций отдельного параметра
		$(".cellParamComboCount").on("click", (event)=>{
			//tr.getElementsByClassName("cellParamComboCount")[0].onclick= (event)=> {
				/**@type{HTMLElement} */
				let el = event.target;
				$(".popup")?.remove();
				if (el===__lastClickTarget) { __lastClickTarget= null;  return; }
				__lastClickTarget= null;
				let iParam= $(".cellParamComboCount").index(el);
				let paramDatas= GetParamsOptimizArrays();
				let text= paramDatas && iParam>=0 ? "Значения:<br>"+[...paramDatas[iParam]].join("<br>") : "";
				if (text==="") return;
				let span = document.createElement('span');
				span.innerHTML = '<div class="popup" style="top:3pt;"><div class="popuptext" id="myPopup" style="width:max-content;margin-left:-20pt">' + text + '</div></div>';
				el.append(span); //'<div className="popuptext" id="myPopup">A Simple Popup!</div>');
				$("#myPopup")[0].classList.toggle("show");
				__lastClickTarget= el;//if (isHover($(".popup"))) alert(113); }// { if (! isHover($(".popuptext")[0])) $(".popup")[0].remove(); }
		});
		document.onclick= (e)=> { if (__lastClickTarget && e.target!==__lastClickTarget && e.target!==document.getElementById("myPopup")) { $(".popup").remove();  __lastClickTarget= null; }}

		let $fee= $("#fee");

		SetAutoStepForElement($fee[0]);


		$(document).on('submit', 'form', function(e){
			e.preventDefault();  // Предотвращаем отправку данных формы
			OnClickStartBtn();
		});


		let cancelToken = new lib.CancelToken();

		/**@type{JQuery<HTMLInputElement>}
		 */
		const $geneticCheckBox = $("#genetic_checkBox");

		/**@type{JQuery<HTMLInputElement>}
		 */
		const $threadsCountInput = $("#threadsCountInput");

		/**@param{boolean} isOptimiz
		 */
		async function OnClickStartBtn(isOptimiz = null)
		{
			if (_testing) { testerSpeedMutable.value= -1;  cancelToken.cancel();  return; }
			//$(".tabs").prop("disabled",true);
			$("[name='tab-btn']").prop("disabled",true);
			//return;
			//$('#startBtn').prop( "disabled", true );

			let isOptimization = isOptimiz ?? $("#tabContentOptimization").is(":visible");

			let startBtn= isOptimization ? $("#startOptimizBtn") : $startBtn;

			startBtn[0].value= "Стоп";

			if (isOptimization) {
				$onlyPositiveResultsCheckBox.attr("disabled", true);
				$threadsCountInput.attr('disabled', true);
				$geneticCheckBox.attr('disabled', true);
			}
			else {
				$visualCheckbox.prop("disabled", true);
				$pauseBtn.prop('disabled', false);
				if (!$visualCheckbox[0].checked) testerSpeedMutable.value = Number.MAX_VALUE;
			}

			$('.header :input, .header select').attr('disabled', true); // Отключаем элементы управления

			_testing= true;
			cancelToken = new lib.CancelToken();

			$("#btnErrorText").remove();

			try {
				if (isOptimization)
					await _Optimizate();
				else await _Test();
			}
			catch(e) { startBtn.parent().append("<div id='btnErrorText' style='color:red'>Ошибка!</div>");  throw(e); }

			finally {
				startBtn[0].value= "Старт";
				//$('#startBtn').prop( "disabled", false );
				if (isOptimization) {
					$onlyPositiveResultsCheckBox.attr("disabled", false);
					$threadsCountInput.attr('disabled', false);
					$geneticCheckBox.attr('disabled', false);
				}
				else {
					$visualCheckbox.prop( "disabled", false );
					$pauseBtn.prop('disabled', true);
					SetPaused(false);
				}

				$('.header :input, .header select').attr('disabled', false); // Возвращаем элементы управления
				//$(".tabs").prop("disabled",false);
				$("[name='tab-btn']").prop("disabled",false);

				_testing= false;
				let audio = new Audio('./expert.wav');
				audio.play();
				//$('form').prop( "disabled", false );
			}
		}

		document.OnClickStartBtn= OnClickStartBtn;


		// async function OnClickOptimizButton()
		// {
		// 	$("#startOptimizBtn")[0].value= "Стоп";
		// 	$(".tabs").prop("disabled",true);
		// 	_Optimizate();
		// 	$("#startOptimizBtn")[0].value= "Старт";
		// 	$(".tabs").prop("disabled",false);
		// }

		/** Получаем массивы оптимизируемых параметров
		 * @param{function(i :number, msg :string) :void} onError    //* @param{boolean} ensureValid - Проверка корректности
		 * @return{(number[]|Error)[]}
		 */
		function GetParamsOptimizArrays( onError= (i, msg)=>{throw("Param "+i+": "+msg)} ) //ensureValid=false)
		{
			let paramsRows= $('#parameters')[0].getElementsByTagName('tbody')[0].getElementsByTagName("tr");

			function ensureValid(i, val) { if (isNaN(val)) { console.error("Parameter "+i+": wrong value: "+val);  if (onError) onError(i, "Wrong value "+val); return false; } return true; }

			/**@type {CParamStepper[]} */
			let allParams= [];
			for(let i=0; i<paramsRows.length; i++)
			{
				let $paramRow= $(paramsRows[i]);
				let isOpt= $paramRow.find('.inputParamCheckBox')[0].checked;
				let value= $paramRow.find('.inputParamValue').val();
				let start=value, end=value, step=1;
				let progres= 1;
				//if (i===0) { console.log("Задаём первый параметр как оптимизируемый!!");  isOpt=true; }
				let ok= true;
				if (isOpt) {
					start= $paramRow.find('.inputParamStart').val();  ok &&= ensureValid(i, start);
					end= $paramRow.find('.inputParamEnd').val();  ok &&= ensureValid(i, end);
					step= $paramRow.find('.inputParamStep').val();  ok &&= ensureValid(i, step);
					progres= $paramRow.find('.inputParamProgres').val();  ok &&= ensureValid(i, step);
				}
				else ok &&= ensureValid(i, value);
				if (! ok) { allParams.push(null);  continue; }
				//start= +start;
				//alert(start + 0 * step);
				//alert(start+"  "+end+"  "+step);
				//params.push({start, end, step});
				try {
					let values;
					if (progres === 1)
						values= new MyTester.CParamStepper(start, end, step);
					else
						values= Param.CreateUniqueValues_start_end_step_stepX_endMatch(start, end, step, progres, Param.E_MATCH_END.FIT, true);
					allParams.push(values);
				}
				catch(msg) { if (onError) onError(i, msg);  allParams.push(null); }//allParams.push(new Error(msg));  if (onError) onError(i, msg); }
			}
			return allParams;
		}


		async function _Optimizate()
		{
			console.log("Optimizate");

			ClearOptimizTable();

			let symbol = $symbol.val();
			let strategy = $strategy.val();
			let startDate = $startDate.val();
			let endDate = $endDate.val();
			let tfName = $tf.val();
			let comission = { value: $fee.val(),  unit: $("#feeType").val() };

			let strategyObj= stategiesMap.get(strategy);  //Strategy_MA;
			if (! strategyObj) throw("Неизвестная стратегия: "+strategy);

			let params= GetParamsOptimizArrays();

			//for(let n of params[0]) alert(n);
			//alert(params[0]);
			//alert("Param1: "+[...params[0]].join(","));//+"\nParam2: "+[...params[1]]);
			//return;
			/**
			 * @type {CSymbolInfo}
			 */
			let symInfo= new CSymbolInfo;
			symInfo.name= symbol;
			symInfo.lotSize= 1;
			symInfo.comissionPerSide= comission;
			//ymInfo.tickSize= 1;
			//symInfo.quoteCurrency= "USD";
			let tickSize= 1;  //symInfo.tickSize= 1;
			let quoteCurrency= "USD"; ////symInfo.quoteCurrency= "USD";
			symInfo.priceInfo= MyTester.MsTradeSymbolQuotes(symbol, tickSize, quoteCurrency);
			/**
			 * @type {CTesterConfig}
			 */
			let config= new CTesterConfig;
			config.startTime= new Date(startDate);
			config.endTime= new Date(endDate);
			config.startBalance= 0;
			let tf= TF.get(tfName);
			//config.defaultTf= TF.get(tfName);
			//alert(config.defaultTF.name);

			let startTimeMs= Date.now();

			let combosTotal= params.reduce((prev, curr)=>prev*curr.length, 1);
			let combosComputed= 0;

			let isGenetic= $geneticCheckBox[0].checked;

			let geneticConfig = isGenetic ? GetGeneticConfig() : null;

			function onOptimizTimer(stopped=false) {
				$("#optimizStatus")[0].style.visibility = "visible";
				let percent= combosComputed*100/combosTotal;
				$("#optimProgressBar")[0].value= percent;
				let elapsedMs= Date.now()-startTimeMs;
				let timeStr= combosTotal<100 && elapsedMs<10000 ? Time.durationToStr_h_mm_ss_ms(elapsedMs) : Time.durationToStr_h_mm_ss(elapsedMs);
				//$("#optimizStatus")[0].innerHTML = combosComputed+"/"+combosTotal+" ("+Math.round(combosComputed*100/combosTotal)+"%)   "+timeStr;
				$("#optimizStatusText")[0].innerHTML = timeStr+"\nВыполнено:  "+combosComputed+"/"+combosTotal+" ("+Math.round(percent)+"%)"
				+"\nСкорость:  "+lib.DblToStrAuto(combosComputed/elapsedMs*1000,-1)+" прох./сек"
				+(!stopped && combosComputed>0 && elapsedMs>2000 && !isGenetic ?  "\nОсталось: ~"+Time.durationToStr((combosTotal-combosComputed)/combosComputed*elapsedMs) : "");
			}


			let timerId= setInterval(onOptimizTimer, 50);

			/**@type{{paramValue,profit}[][]}
			 */
			let profitsByParamValue= [];

			let threadCount= $threadsCountInput.val();

			//console.log(geneticConfig);  return;

			//alert(threadCount);  return;
			let localTimeMs= 0;
			try {
				await MyTester.Optimizate({symbolInfo: symInfo, strategy: strategyObj}, tf,  params,  config,  threadCount,  geneticConfig,  OnGetResult, cancelToken);//, testerSpeedMutable);
			}
			finally { clearInterval(timerId); }

			onOptimizTimer(true);
			// Показать кнопки в таблице результатов
			$(".optResultButtonCell").show(); //$("#optimizTableBody button").show();


			/**@param {number[]} params
			 * @param {TradeStatistics} result
			 * @param {number[]} equityValues
			 */
			async function OnGetResult(params, result, equityValues= null) {
				combosComputed++;
				console.log("got result:");
				console.log("params: "+[...params].join(",")+"\nprofit: "+result?.resultProfit);
				if (result.resultProfit>0 || ! $onlyPositiveResultsCheckBox[0].checked)
					if (result) AddResultToOptimizTable(params, result, equityValues);

				for(let i=0; i<params.length; i++) {
					if (!profitsByParamValue[i]) profitsByParamValue[i] = [];
					profitsByParamValue[i].push({paramValue: params[i], profit: result.resultProfit})
				}
				//await lib.sleepAsync(0);
				if (0)
				if (Date.now()-localTimeMs>50) {
					await lib.sleepAsync(0);
					//$('.tsort').tsort();
					// $("#optimizTable").tablesorter();
					localTimeMs= Date.now();
				}
			}

			// Сортируем значения каждого параметра по прибыли
			for(let paramData of profitsByParamValue)
				paramData.sort((a,b)=>Math.sign(a.profit,b.profit));


			let div= $("#optimizParamRangesDiv");
			div.empty();
			for(let i=0; i<params.length; i++) {
				let paramName= strategyObj.params[i].name;
				let valueId= "rangeVal"+i;
				let rangeId= "optimizInputRange"+i;
				div.append(`
					<div><label>${paramName}
					<div>
						<div id="${valueId}" class="rangeVal"></div>
						<input id="${rangeId}" class="optimizInputRange" type="range">
					</div>
					</label></div>
				`);
				/**@type{HTMLInputElement}
				 */
				let rangeElem= $("#"+rangeId)[0];
				rangeElem.oninput= ()=> {
					let paramDatas= profitsByParamValue[i];
					if (! paramDatas || paramDatas.length===0) return;
					const value = +rangeElem.value;
					const min = rangeElem.min || 0;
					const max = rangeElem.max || 100;
					const ratio = (value - min) / (max - min);

					let iData=  Math.round(ratio * (paramDatas.length-1));
					iData= paramDatas.length - 1 - iData;   // В обратном порядке, т.к. убытки у нас справа, а прибыли слева

					displayRangeValue(rangeElem, $("#" + valueId)[0], paramDatas[iData].paramValue)
				}
				//<input class="optimizInputRange" type="range" oninput="displayValue(this, document.getElementById('${spanId}'))">
			}
		}



		async function _Test() {
			//$('#startBtn').prop( "disabled", true );
			console.log("Test");

			let symbol = $symbol.val();
			let strategy = $strategy.val();
			let startDate = $startDate.val();
			let endDate = $endDate.val();
			let tfName = $tf.val();

			let comission = { value: $fee.val(),  unit: $("#feeType").val() };

			// src="./Tester.js">

			//import * as aaa from "./Tester.js";
			//alert("!");
			//console.log(stategiesMap.keys());
			
			let strategyObj= stategiesMap.get(strategy);  //Strategy_MA;
			if (! strategyObj) throw("Неизвестная стратегия: "+strategy);

			let paramElements= $('#parameters tbody .inputParamValue');
			if (paramElements.length !== strategyObj.params.length) {
				throw("Wrong parameters count: "+paramElements.length+" != "+strategyObj.params.length);
			}
			//alert(paramElements.length);
			let params= [];
			for(let i=0; i<paramElements.length; i++) {
				let val= paramElements[i].value;
				if (isNaN(val)) { alert("Parameter "+i+": wrong value: "+val);  return; }
				params.push(val);
			}
			/**
			 * @type {CSymbolInfo}
			 */
			let symInfo= new CSymbolInfo;
			symInfo.name= symbol;
			symInfo.lotSize= 1;
			symInfo.comissionPerSide= comission;
			let tickSize= 1;  //symInfo.tickSize= 1;
			let quoteCurrency= "USD"; ////symInfo.quoteCurrency= "USD";
			symInfo.priceInfo= MyTester.MsTradeSymbolQuotes(symbol, tickSize, quoteCurrency);
			/**
			 * @type {CTesterConfig}
			 */
			let config= new CTesterConfig;
			config.startTime= new Date(startDate);
			config.endTime= new Date(endDate);
			config.startBalance= 0;
				//defaultSymbol : null,
				//defaultTF : tf
			/**
			 * @type {CTesterInfo}
			 */
			let testerInfo= new CTesterInfo;
			testerInfo.config= config;
			testerInfo.symInfo= symInfo;
			testerInfo.strategyTf= TF.get(tfName);
			testerInfo.strategy= strategyObj;
			testerInfo.strategyParams= params;

			ClearTradeTable();
			$quotesChart.empty(); //innerHTML= "";
			$equityChart.empty(); //.innerHTML= "";

			$("#statisticsTableBody").empty();

			$("#testProgressBar")[0].value= 0;
			//setInterval(()=>testProgressBar)

			// Функция прокрутки
			function onTesterProgress(percent) { $("#testProgressBar")[0].value= percent; }

			//import type * as MyTester from "./MyTester";

			/** Функция прокрутки к выбранной дате
			 * @type{function(time :string)}
			 */
			let _scrollChartFunc = null;

			/** Функция добавления сделки в таблицу
			 * @param{TradeData[]} trades
			 * @param{function(time :string)} scroller  // функция прокрутки к выбранной дате на графике
			 */
			function addTradesToTable(trades, scroller) { _scrollChartFunc= scroller;  AddTradesToTable(trades, scroller); }


			let result = await MyTester.Test(testerInfo, $quotesChart[0], $equityChart[0], addTradesToTable, testerSpeedMutable, onTesterProgress);
			console.log("finish");

			//import {ShowStatistics} from "./index_helper.js";
			/** type{ShowStatistics_type} */
			let showStatistics;//= ShowStatistics;
			showStatistics()
			//import {ShowStatistics} from "./index_helper.js";
			ShowStatistics()
			//ShowStatistics(result, (time)=>_scrollChartFunc(time.toString()));

			// /** @param {TradeStatistics} stat
			//  */
			// function ShowStatistics(stat) // : Readonly<MyTester.TradeStatistics>)
			// {
			// 	let table= $("#statisticsTableBody");
			// 	table.empty();
			// 	if (!stat) return;
			//
			// 	function push(name, value, value2=undefined, unit=undefined) {
			// 		if (unit) unit=" "+unit; else unit="";
			// 		function valToStr(val) { return val instanceof Date ? timeToStr_yyyymmdd_hhmm(val) : !isNaN(val) ? lib.DblToStrAuto(val, -4)+unit : val; }
			// 		value= valToStr(value);
			// 		let tr = document.createElement("tr");
			// 		if (value===undefined) value="-";
			// 		else if (value2!==undefined) value += " &nbsp;("+ valToStr(value2) + ")";
			// 		tr.innerHTML = `<td>${name}</td> <td>${value}</td>`;
			// 		if (value2 instanceof Date) {
			// 			let el= $(tr).children()[1];
			// 			el.style.cursor="pointer";  el.onclick= ()=>_scrollChartFunc(value2.toString());
			// 		}
			// 		table.append(tr);
			//
			// 		return $(tr).children()[1];
			// 	}
			//
			// 	function push$(name, value, value2=undefined) { return push(name, value, value2, "$"); }
			//
			// 	push$("Прибыль", stat.resultProfit);
			// 	push$("Максимум прибыли",stat.maxProfit, stat.maxProfitTime);
			// 	push$("Минимум прибыли",stat.minProfit, stat.minProfitTime);
			// 	push$("Макс. просадка ",stat.maxDrawdown, stat.maxDrawdownTime);
			// 	push("Всего сделок",stat.trades);
			// 	push("Число покупок",stat.buys);
			// 	push("Число продаж",stat.sells);
			// 	push("Всего лотов",stat.totalVolumes);
			// 	push("Лотов на покупку",stat.buyVolumes);
			// 	push("Лотов на продажу",stat.sellVolumes);
			// 	push$("Комиссии",stat.comissions);
			// 	push$("Средний профит на сделку",stat.avrgProfitPerTrade);
			// 	push$("Средний профит на лот",stat.avrgProfitPerVolume);
			// 	push("Средняя длительность позиции",Time.durationToStr(stat.avrgTradeDuration_ms));
			// 	push("Фактор восстановления",stat.recoveryFactor);
			// 	push("Коэффициент Шарпа",stat.sharpCoef);
			// }
			//document.getElementById(quotesChartName).innerText= symbol;
			//document.getElementById(quotesChartName).innerHTML= symbol;
			$quotesChartName[0].innerText = symbol+", "+tfName;
			//alert($("#quotesChartName").text());
			//alert("!");
				//alert(params);

			//let signaller= strategyInfo.getSignaller(params);

			//Tester.RunSignallerTest(signaller, params, 5);

			//alert(symbol+"  "+strategy+"  "+startDate);
		}

		//Test();
	</script>


	<script>
		/**
		 * @param{HTMLInputElement} rangeElement
		 * @param{HTMLDivElement} valueElement
		 * @param{string} valueStr
		 */
		function displayRangeValue (rangeElement, valueElement, valueStr=null) {
			const inp = rangeElement;
			const value= +inp.value;
			const min = inp.min || 0;
			const max = inp.max || 100;
			const width = inp.offsetWidth;
			const offset = -20;
			const percent = (value - min) / (max - min);
			const pos = percent * (width + offset);// - 40;
			//const pos = percent * (width);
			valueElement.innerHTML = valueStr ?? value;
			//console.log("percent="+percent,"width="+width, "offset="+offset," pos="+pos)
			valueElement.style.marginLeft = pos+'px';
		}

	</script>

</html>